<Page x:Class="ToxicBizBuddyWPF.Views.OrdersPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:components="clr-namespace:ToxicBizBuddyWPF.Components"
      xmlns:conv="clr-namespace:ToxicBizBuddyWPF.Converters"
      Title="Gestión de Pedidos">

    <Page.Resources>
        <conv:ItemsToStringConverter x:Key="ItemsToStringConverter"/>

        <!-- Card -->
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="16"/>
        </Style>

        <!-- ⚠️ NO redefinimos BtnPrimary aquí: hereda el global (celeste) de Styles.xaml -->

        <Style x:Key="BtnGhost" TargetType="Button">
            <Setter Property="Foreground" Value="#111827"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="6,0"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="IconButtonGhost" TargetType="Button">
            <Setter Property="Width" Value="34"/>
            <Setter Property="Height" Value="34"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="IconButtonGhostSm" TargetType="Button" BasedOn="{StaticResource IconButtonGhost}">
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
        </Style>

        <!-- Tipografía -->
        <Style x:Key="Icon" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="H1" TargetType="TextBlock">
            <Setter Property="FontSize" Value="28"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#0F172A"/>
        </Style>
        <Style x:Key="Subtle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="#6B7280"/>
        </Style>
        <Style x:Key="SectionTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#0F172A"/>
        </Style>
        <Style x:Key="OrderLink" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#2563EB"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Badges -->
        <Style x:Key="BadgeSquareBase" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="BadgeCompletedUltra" TargetType="Border" BasedOn="{StaticResource BadgeSquareBase}">
            <Setter Property="Background" Value="#E6FAF1"/>
            <Setter Property="BorderBrush" Value="#B9F2DC"/>
            <Setter Property="Padding" Value="1,0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>
        <Style x:Key="BadgePendingUltra" TargetType="Border" BasedOn="{StaticResource BadgeSquareBase}">
            <Setter Property="Background" Value="#FFF6D6"/>
            <Setter Property="BorderBrush" Value="#FFE29B"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>
        <Style x:Key="BadgeCanceledUltra" TargetType="Border" BasedOn="{StaticResource BadgeSquareBase}">
            <Setter Property="Background" Value="#FFE2E2"/>
            <Setter Property="BorderBrush" Value="#FFB8B8"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>
        <Style x:Key="BadgeText" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="BadgeIcon" TargetType="TextBlock" BasedOn="{StaticResource Icon}">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Margin" Value="0,0,4,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- DataGrid base -->
        <Style x:Key="DataGridBase" TargetType="DataGrid">
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="RowBackground" Value="White"/>
            <Setter Property="AlternatingRowBackground" Value="White"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="RowHeight" Value="44"/>
            <Setter Property="ColumnHeaderHeight" Value="36"/>
            <Setter Property="HorizontalGridLinesBrush" Value="#E5E7EB"/>
            <Setter Property="VerticalGridLinesBrush" Value="#E5E7EB"/>
            <Setter Property="SelectionUnit" Value="FullRow"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGrid">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="8">
                            <ScrollViewer x:Name="DG_ScrollViewer">
                                <ScrollViewer.Template>
                                    <ControlTemplate TargetType="ScrollViewer">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <Grid Grid.Row="0" Background="White" Height="36">
                                                <DataGridColumnHeadersPresenter/>
                                            </Grid>
                                            <ScrollContentPresenter Grid.Row="1"/>
                                        </Grid>
                                    </ControlTemplate>
                                </ScrollViewer.Template>
                                <ItemsPresenter/>
                            </ScrollViewer>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Header/celdas compactos -->
        <Style x:Key="FlatDataGridHeader" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#0F172A"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="BorderBrush" Value="#EAECEF"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style x:Key="LeftHeader" TargetType="DataGridColumnHeader" BasedOn="{StaticResource FlatDataGridHeader}">
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
        </Style>
        <Style x:Key="CenterHeader" TargetType="DataGridColumnHeader" BasedOn="{StaticResource FlatDataGridHeader}">
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
        </Style>
        <Style x:Key="RightHeader" TargetType="DataGridColumnHeader" BasedOn="{StaticResource FlatDataGridHeader}">
            <Setter Property="HorizontalContentAlignment" Value="Right"/>
        </Style>

        <Style x:Key="FlatDataGridRow" TargetType="DataGridRow">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridRow">
                        <Border x:Name="RowRoot" Background="{TemplateBinding Background}">
                            <Grid>
                                <SelectiveScrollingGrid>
                                    <SelectiveScrollingGrid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </SelectiveScrollingGrid.ColumnDefinitions>
                                    <SelectiveScrollingGrid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </SelectiveScrollingGrid.RowDefinitions>
                                    <DataGridCellsPresenter Grid.Column="1" Grid.Row="0"
                                                            SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                    <Border Grid.ColumnSpan="2" Grid.Row="1" Height="1" Background="#EAECEF"/>
                                </SelectiveScrollingGrid>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="RowRoot" Property="Background" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="RowRoot" Property="Background" Value="#FAFBFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FlatDataGridCell" TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="2,0"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="ClipToBounds" Value="True"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="#0F172A"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Page.Resources>

    <components:PageWrapper>
        <Grid Background="#F8FAFF">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Grid Margin="24,20,24,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Gestión de Pedidos" Style="{StaticResource H1}"/>
                    <TextBlock Text="Administra todos los pedidos de tus clientes"
                               Style="{StaticResource Subtle}" Margin="0,4,0,0"/>
                </StackPanel>

                <!-- Botón igual al de ClientsPage -->
                <Button Grid.Column="1"
                        Style="{StaticResource BtnPrimary}"
                        Padding="10,6"
                        Click="NewOrder_Click">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="" FontFamily="Segoe MDL2 Assets" Margin="0,0,6,0"/>
                        <TextBlock Text="+ Nuevo pedido"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Buscador + Filtros -->
            <Border Grid.Row="1" Margin="24,0,24,16" Padding="8"
                    Background="White" BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Border CornerRadius="8" BorderBrush="#E5E7EB" BorderThickness="1" Background="White" Padding="10" Margin="0,0,8,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Style="{StaticResource Icon}" Text="&#xE721;" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Grid.Column="1" BorderThickness="0" Background="Transparent" Tag="Buscar por cliente o número de pedido…"/>
                        </Grid>
                    </Border>
                    <Button Grid.Column="1" Style="{StaticResource BtnGhost}" Click="OpenFilters_Click">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Style="{StaticResource Icon}" Text="&#xE16E;" Margin="0,0,8,0"/>
                            <TextBlock Text="Filtros" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>

            <!-- Lista de pedidos -->
            <Border Grid.Row="2" Margin="24" Style="{StaticResource CardStyle}">
                <StackPanel>
                    <TextBlock Text="Lista de Pedidos" Style="{StaticResource SectionTitle}" Margin="0,0,0,8"/>
                    <Separator Background="#E5E7EB" Height="1" Margin="0,8,0,8"/>

                    <DataGrid Tag="OrdersGridRef"
                              IsReadOnly="True"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              HeadersVisibility="Column"
                              GridLinesVisibility="None"
                              RowStyle="{StaticResource FlatDataGridRow}"
                              CellStyle="{StaticResource FlatDataGridCell}"
                              Style="{StaticResource DataGridBase}"
                              ColumnHeaderStyle="{StaticResource FlatDataGridHeader}"
                              SelectionChanged="OrdersGrid_SelectionChanged"
                              ColumnWidth="*"
                              HorizontalScrollBarVisibility="Auto"
                              CanUserResizeColumns="False">

                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Pedido" Width="*" MinWidth="100" HeaderStyle="{StaticResource LeftHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Pedido}"
                                                   Style="{StaticResource OrderLink}"
                                                   FontSize="14"
                                                   TextAlignment="Left"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"
                                                   MouseLeftButtonDown="OpenOrderLink_Click"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Cliente" Width="*" MinWidth="140" HeaderStyle="{StaticResource LeftHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Cliente}" FontSize="14"
                                                   TextAlignment="Left" VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Fecha" Width="*" MinWidth="110" HeaderStyle="{StaticResource CenterHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Fecha, StringFormat='{}{0:yyyy-MM-dd}'}" FontSize="14"
                                                   Foreground="#64748B" TextAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Items" Width="*" MinWidth="90" HeaderStyle="{StaticResource CenterHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Items, Converter={StaticResource ItemsToStringConverter}}" FontSize="14"
                                                   TextAlignment="Center" VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Estado" Width="*" MinWidth="120" HeaderStyle="{StaticResource CenterHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Style="{StaticResource BadgeCompletedUltra}" VerticalAlignment="Center" Margin="0,0,8,0">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Style="{StaticResource BadgeIcon}" FontSize="14" Text="&#xE73E;"/>
                                                <TextBlock Style="{StaticResource BadgeText}" FontSize="14" Text="{Binding Estado}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Total" Width="*" MinWidth="130" HeaderStyle="{StaticResource CenterHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Total, StringFormat='{}{0:$0.00}'}" FontWeight="SemiBold" FontSize="14"
                                                   TextAlignment="Center" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Acciones" Width="*" MinWidth="200" HeaderStyle="{StaticResource CenterHeader}">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <Button Style="{StaticResource IconButtonGhostSm}" ToolTip="Ver" Click="ViewOrder_Click">
                                                <TextBlock Style="{StaticResource Icon}" Text="&#xE8F4;" FontSize="14"/>
                                            </Button>
                                            <Button Style="{StaticResource IconButtonGhostSm}" ToolTip="Editar" Click="EditOrder_Click">
                                                <TextBlock Style="{StaticResource Icon}" Text="&#xE70F;" FontSize="14"/>
                                            </Button>
                                            <Button Style="{StaticResource IconButtonGhostSm}" ToolTip="Duplicar" Click="DuplicateOrder_Click">
                                                <TextBlock Style="{StaticResource Icon}" Text="&#xE8C8;" FontSize="14"/>
                                            </Button>
                                            <Button Style="{StaticResource IconButtonGhostSm}" ToolTip="Eliminar" Click="DeleteOrder_Click" Margin="0">
                                                <TextBlock Style="{StaticResource Icon}" Text="&#xE74D;" FontSize="14"/>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>

            <!-- Paginación -->
            <StackPanel Grid.Row="3" Margin="24,0,24,16" HorizontalAlignment="Right">
                <components:Pagination/>
            </StackPanel>
        </Grid>
    </components:PageWrapper>
</Page>
